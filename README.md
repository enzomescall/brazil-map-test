## Brazil Map Test

### Project Objective

Build a real-time (accelerated) simulation where the player manages national resources generated by regional provinces (Brazilian states) via tax collection.

### Current Functional State

- **Time/Economy Ticker:** The game advances daily, accumulating national treasury resources.
- **UI Updates:** The top bar (HUD) displays the current date and national treasury, updating in real time via signals.
- **Map Interaction:** Players can click on four defined provinces (Amazonas, São Paulo, Rio de Janeiro, Minas Gerais).
- **Province Inspector:** Clicking a province opens a dynamic panel displaying its specific data (Population, GDP, Stability, Daily Income).

### Project Directory and Scene Hierarchy

All scripts are contained within dedicated folders. Note the use of `class_name` for data models.

```
/project_root
├── scenes/
│   ├── World.tscn            # Main Scene, hosts all controllers
│   ├── HUD.tscn              # Top bar UI
│   └── ProvinceInspector.tscn
└── scripts/
    ├── data_models/
    │   └── province_data.gd  # Global Data Model Class
    ├── game_manager.gd       # Simulation Engine
    ├── map_manager.gd        # Map and Click Handler
    ├── hud.gd                # Top Bar UI Controller
    └── province_inspector.gd # Inspector UI Controller
```

#### World.tscn Scene Hierarchy (Runtime Tree)

- `World` (Node2D, attached `map_manager.gd`)
  - `VisualMap` (Sprite2D)
  - `Camera2D`
  - `GameManager` (Node, attached `game_manager.gd`)
  - `TopBar` (CanvasLayer, attached `hud.gd`)  <-- UI ROOT LAYER
    - `HBoxContainer` (Contains Date, Resources, Speed Buttons)
    - `ProvinceInspector` (PanelContainer, attached `province_inspector.gd`)

Key relationship: `ProvinceInspector` and `HBoxContainer` are children of the `TopBar` (CanvasLayer) so they remain fixed to the viewport and ignore camera movement and zoom. Non-interactive UI containers have `mouse_filter` set to `Ignore` so map clicks reach `map_manager.gd`'s `_unhandled_input`.

## Core Data Model: `province_data.gd`

This file defines the global data structure for provinces using `class_name` to allow type-hinting across scripts.

```gdscript
extends RefCounted
class_name ProvinceData

var name: String
var color: Color
var population: int
var gdp_billions: float # GDP stored in billions
var stability: float = 0.85 # 85% starting stability

func _init(p_name: String = "", p_color: Color = Color.WHITE, p_pop: int = 0, p_gdp: float = 0.0) -> void:
    name = p_name
    color = p_color
    population = p_pop
    gdp_billions = p_gdp

func process_turn(tax_rate: float) -> float:
    # Daily income calculation: (GDP * tax_rate) / 360 days
    var daily_income: float = (gdp_billions * 1_000_000_000.0) * (tax_rate / 360.0)
    # Stability penalty applied
    daily_income *= stability
    return daily_income
```

## Simulation Engine: `game_manager.gd`

Key variables and constants:

- `national_treasury: float = 10_000_000_000.0`
- `game_speed_setting: int = 1`
- `tax_rate: float = 0.15`

Core logic (in `advance_day()`):

- Increments day, month, and year.
- Iterates through all provinces in `map_manager.province_registry`.
- Calls `province.process_turn(tax_rate)` for each province and accumulates daily income into `national_treasury`.
- Emits signals: `date_changed(date_str: String)` and `resources_updated(national_treasury: float)`.

## Map Interaction Logic: `map_manager.gd`

Handles loading the color map, registering provinces, and detecting clicks.

Data structure:

- `province_registry: Dictionary`
  - Key: HTML color string (e.g., `2e6a32` without `#`)
  - Value: `ProvinceData` instance

Example snippets:

```gdscript
func setup_brazil_data() -> void:
    # Amazonas (Hex: #2e6a32 -> RGB: 46, 106, 50)
    register_province("Amazonas", Color(0.180, 0.416, 0.196), 4200000, 100.0)
    # São Paulo (Hex: #2e6396 -> RGB: 46, 99, 150)
    register_province("São Paulo", Color(0.180, 0.388, 0.588), 44000000, 600.0)

func register_province(p_name: String, p_color: Color, p_pop: int, p_gdp: float) -> void:
    var new_prov: ProvinceData = ProvinceData.new(p_name, p_color, p_pop, p_gdp)
    var color_key: String = p_color.to_html(false)
    province_registry[color_key] = new_prov

func handle_click(global_pos: Vector2) -> void:
    var clicked_color: Color = map_image.get_pixel(int(pixel_x), int(pixel_y))
    var color_key: String = clicked_color.to_html(false)
    if province_registry.has(color_key):
        selected_province = province_registry[color_key] as ProvinceData
        province_selected.emit(selected_province)
    else:
        province_selected.emit(null)
```

Note: Click detection relies on a strict string match between the color read from the texture and the registry key.

## User Interface Logic

### `hud.gd` (Top Bar Controller)

- Uses exported node references (e.g., `@export var game_manager`) to avoid nulls at startup.
- Listens to `game_manager.date_changed` and `game_manager.resources_updated`.
- Formats `national_treasury` in billions for display (e.g., `R$ X.XX B`).

### `province_inspector.gd` (Inspector Panel)

- Connected to `map_manager.province_selected(data: ProvinceData)`.
- On province click, shows the inspector and updates labels: Name, Population, GDP, Stability, Daily Income.
- Ensure population formatting uses thousand separators, e.g.:

```gdscript
pop_label.text = "Population: " + "{:,}".format([province_data.population])
```

- Daily Income is displayed using `province_data.process_turn(0.15)`.

## Current Status and Next Steps

- **Status:** Core loop (time, money, click, inspector) is stable and functional.
- **Next steps:**
  - Implement map highlighting on click (visual feedback).
  - Add policy buttons to the inspector (e.g., `Adjust Tax Rate`, `Invest in Province`).
  - Implement random events (e.g., `Drought in Amazonas reduces GDP`).
